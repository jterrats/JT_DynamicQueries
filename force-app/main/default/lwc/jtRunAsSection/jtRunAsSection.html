<template>
  <div class="slds-box slds-box_x-small slds-theme_shade slds-m-bottom_medium">
    <div class="slds-media slds-media_center slds-m-bottom_small">
      <div class="slds-media__figure">
        <lightning-icon
          icon-name="utility:user"
          size="small"
          alternative-text={labels.user}
        ></lightning-icon>
      </div>
      <div class="slds-media__body">
        <h3 class="slds-text-heading_small">
          <strong>{labels.runAsUser}</strong>
        </h3>
      </div>
    </div>

    <!-- Info Note -->
    <div class="slds-box slds-box_xx-small slds-theme_info slds-m-bottom_small">
      <div class="slds-media slds-media_small">
        <div class="slds-media__figure">
          <lightning-icon
            icon-name="utility:info"
            size="xx-small"
            variant="info"
          ></lightning-icon>
        </div>
        <div class="slds-media__body">
          <p class="slds-text-body_regular">{labels.noteText}</p>
          <p class="slds-text-body_small slds-m-top_xx-small">
            <lightning-icon
              icon-name="utility:success"
              size="xx-small"
              class="slds-m-right_xx-small"
            ></lightning-icon>
            <strong>{labels.whenSelectUserMessage}</strong>
          </p>
        </div>
      </div>
    </div>

    <!-- User Selection -->
    <c-jt-searchable-combobox
      label={labels.selectUserToImpersonate}
      placeholder={labels.selectUserPlaceholder}
      options={userOptions}
      icon-name="standard:user"
      disabled={isComboboxDisabled}
      data-testid="run-as-user-selector"
      name="run-as-user"
      onselect={handleUserSelect}
      onclear={handleUserClear}
    ></c-jt-searchable-combobox>

    <!-- Loading Users -->
    <template if:true={isLoadingUsers}>
      <div
        class="slds-text-body_small slds-text-color_weak slds-m-top_small"
        role="status"
        aria-live="polite"
        aria-label={labels.loadingUsersAria}
      >
        <lightning-spinner
          alternative-text={labels.loadingUsers}
          size="small"
        ></lightning-spinner>
        <span>{labels.loadingUsers}</span>
      </div>
    </template>

    <!-- Action Button (when user selected) -->
    <template if:true={showButtons}>
      <div
        class="slds-p-top_x-small slds-grid slds-grid_align-end"
        role="group"
        aria-label={labels.userImpersonationActions}
      >
        <lightning-button
          label={labels.clearSelection}
          title={labels.clearSelection}
          onclick={handleClearSelection}
          variant="neutral"
          icon-name="utility:clear"
          size="small"
          data-testid="run-as-clear-button"
          name="run-as-clear"
          disabled={isRunningTest}
          aria-label={labels.clearSelectedUser}
        ></lightning-button>
      </div>
    </template>

  </div>

  <!-- Full-screen Running Test Indicator -->
  <template if:true={isRunningTest}>
    <div
      class="run-as-spinner-overlay"
      role="status"
      aria-live="polite"
      aria-label={labels.testExecutionInProgress}
    >
      <lightning-spinner
        alternative-text={labels.executingTestWithSystemRunAs}
        size="large"
      ></lightning-spinner>
      <p>
        {labels.executingTestWithSystemRunAs}
      </p>
    </div>
  </template>
</template>