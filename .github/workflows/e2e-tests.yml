name: E2E Tests

# Temporarily disabled - configure environment variables first
on:
  workflow_dispatch: # Manual trigger only for now
    inputs:
      org_alias:
        description: "Salesforce Org Alias"
        required: true
        default: "DevHub"

# Uncomment when ready:
# on:
#   push:
#     branches: [ main, develop ]
#   pull_request:
#     branches: [ main ]

jobs:
  e2e-tests:
    name: Run Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Setup Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      # TODO: Configure these secrets in GitHub repository settings
      - name: Authenticate to Salesforce
        env:
          SF_AUTH_URL: ${{ secrets.SF_AUTH_URL }}
        run: |
          echo "$SF_AUTH_URL" > auth_url.txt
          sf org login sfdx-url --sfdx-url-file auth_url.txt --alias ${{ github.event.inputs.org_alias || 'DevHub' }} --set-default
          rm auth_url.txt

      - name: Run E2E Tests (Headed Mode)
        run: npm run test:e2e:headed
        env:
          PLAYWRIGHT_HEADED: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Test Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos
          path: test-results/
          retention-days: 30

      - name: Comment PR with Test Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'playwright-report/index.html';

            let comment = '## üé≠ E2E Test Results\n\n';

            if (fs.existsSync(reportPath)) {
              comment += '‚úÖ Tests completed. [View full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
              comment += 'üìπ Test videos are available in the artifacts section.';
            } else {
              comment += '‚ùå Tests failed. Check the logs for details.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# Required Secrets (configure in repository settings):
# - SF_AUTH_URL: Salesforce authentication URL
#   Generate with: sf org display --verbose --json | jq -r '.result.sfdxAuthUrl'

