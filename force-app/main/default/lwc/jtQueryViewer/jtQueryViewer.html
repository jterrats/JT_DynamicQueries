<template>
  <!-- Skip Link for Accessibility -->
  <a href="#main-content" class="slds-assistive-text slds-p-around_xxx-small"
    >{labels.skipToMainContent}</a
  >

  <!-- Live Region for Screen Reader Announcements -->
  <div
    class="slds-assistive-text"
    role="status"
    aria-live="polite"
    aria-atomic="true"
  >
    {srAnnouncement}
  </div>

  <!-- Initial Loading Spinner Overlay -->
  <!-- Only show when loading AND no modals are open (modals have higher z-index) -->
  <template if:true={isInitialLoading}>
    <template if:false={hasOpenModals}>
      <div
        class="initial-loading-overlay slds-is-fixed"
        role="status"
        aria-live="polite"
        aria-label={labels.loadingApplication}
      >
        <lightning-spinner
          alternative-text={labels.loadingDynamicQueryViewer}
          size="large"
          variant="brand"
        ></lightning-spinner>
      </div>
    </template>
  </template>

  <!-- Usage Search Spinner Overlay -->
  <!-- Show while searching for usage, before modal appears -->
  <template if:true={isLoadingUsage}>
    <div
      class="usage-search-spinner-overlay slds-is-fixed"
      role="status"
      aria-live="polite"
      aria-label={labels.searchingForUsage}
    >
      <div
        class="slds-grid slds-grid_vertical slds-grid_align-center slds-grid_align-space-around slds-text-align_center"
        style="max-width: 500px"
      >
        <p class="slds-text-heading_small slds-m-bottom_medium">
          {labels.searchingFlows}
        </p>
        <lightning-spinner
          alternative-text={labels.searching}
          size="large"
          variant="brand"
        ></lightning-spinner>
        <p
          class="slds-m-top_medium slds-text-body_regular slds-max-medium-text-width"
        >
          {searchingUsageMessage}
        </p>
      </div>
    </div>
  </template>

  <lightning-card title={labels.dynamicQueryViewer} icon-name="custom:custom63">
    <!-- Card Header Actions -->
    <div slot="actions">
      <div
        class="slds-grid slds-grid_vertical-align-center slds-grid_align-end"
      >
        <!-- Clear Cache Button (Always visible - non-destructive operation) -->
        <lightning-button
          label={labels.clearCache}
          title={labels.clearCacheAndRefresh}
          onclick={handleOpenCacheModal}
          variant="neutral"
          icon-name="utility:refresh"
          class="slds-m-right_x-small"
          data-testid="header-clear-cache-button"
          name="clear-cache"
          aria-label={labels.openCacheManagementModal}
        >
        </lightning-button>

        <!-- Create Configuration Button (Sandbox/Scratch only) -->
        <template if:true={canCreateMetadata}>
          <lightning-button
            label={labels.createConfiguration}
            title={labels.createNewQueryConfiguration}
            onclick={handleShowCreateModal}
            variant="brand"
            icon-name="utility:add"
            data-testid="header-create-config-button"
            name="create-configuration"
            aria-label={labels.createNewQueryConfigurationAria}
          >
          </lightning-button>
        </template>

        <!-- Edit Configuration Button (Sandbox/Scratch only + config selected) -->
        <template if:true={showEditConfigButton}>
          <lightning-button
            label={labels.editConfigurationNew}
            title={labels.editSelectedConfiguration}
            onclick={handleShowEditModal}
            variant="neutral"
            icon-name="utility:edit"
            class="slds-m-left_x-small"
            data-testid="header-edit-config-button"
            name="edit-configuration"
            aria-label={labels.editSelectedQueryConfigurationAria}
          >
          </lightning-button>
        </template>

        <!-- Delete Configuration Button (Sandbox/Scratch only + config selected) -->
        <template if:true={showDeleteConfigButton}>
          <lightning-button
            label={labels.deleteConfiguration}
            title={labels.deleteSelectedConfiguration}
            onclick={handleDeleteConfiguration}
            variant="destructive"
            icon-name="utility:delete"
            class="slds-m-left_x-small slds-m-right_small"
            data-testid="header-delete-config-button"
            name="delete-configuration"
            aria-label={labels.deleteSelectedQueryConfigurationAria}
          >
          </lightning-button>
        </template>

        <!-- Org Badge -->
        <template if:true={canCreateMetadata}>
          <lightning-badge
            label={orgTypeBadge}
            title={orgTypeBadgeTitle}
            class="slds-m-left_small"
          ></lightning-badge>
        </template>
        <template if:true={isProduction}>
          <lightning-badge
            label={labels.production}
            variant="inverse"
            title={labels.readOnlyModeInProduction}
          ></lightning-badge>
        </template>
      </div>
    </div>

    <!-- Main Content Region -->
    <div
      id="main-content"
      class="slds-p-around_medium"
      role="main"
      aria-label={labels.queryViewerMainContent}
    >
      <!-- Production Warning Banner with Override Option -->
      <template if:true={isProduction}>
        <div class="slds-m-bottom_medium">
          <div
            class="slds-notify slds-notify_alert slds-alert_warning"
            role="alert"
          >
            <span class="slds-assistive-text">{labels.warning}</span>
            <span
              class="slds-icon_container slds-icon-utility-warning slds-m-right_small"
            >
              <lightning-icon
                icon-name="utility:warning"
                size="small"
                variant="warning"
                alternative-text={labels.warning}
              ></lightning-icon>
            </span>
            <div>
              <h2 class="slds-m-bottom_small">
                <strong>{labels.productionEnvironmentDetected}</strong>
              </h2>
              <p class="slds-text-body_regular slds-m-bottom_medium">
                {labels.metadataCreationDisabled}
              </p>

              <!-- Advanced Override for Starter/Free Editions -->
              <div
                class="slds-box slds-box_x-small slds-theme_alert-texture slds-m-top_small"
              >
                <h3 class="slds-text-heading_small slds-m-bottom_small">
                  <lightning-icon
                    icon-name="utility:warning"
                    size="xx-small"
                    variant="warning"
                    class="slds-m-right_xx-small"
                  ></lightning-icon>
                  <strong>{labels.advancedOptionStarterFree}</strong>
                </h3>
                <p class="slds-text-body_small slds-m-bottom_small">
                  {labels.starterFreeEditionWarning}
                </p>
                <div class="slds-m-bottom_small">
                  <lightning-input
                    type="checkbox"
                    label={labels.enableMetadataEditingProduction}
                    checked={productionOverrideEnabled}
                    onchange={handleProductionOverrideChange}
                    disabled={isUpdatingSettings}
                    class="production-override-checkbox"
                  >
                  </lightning-input>
                </div>
                <div
                  class="slds-scoped-notification slds-media slds-media_center slds-scoped-notification_light"
                  role="status"
                >
                  <div class="slds-media__figure">
                    <lightning-icon
                      icon-name="utility:ban"
                      size="small"
                      variant="error"
                      alternative-text={labels.danger}
                    ></lightning-icon>
                  </div>
                  <div class="slds-media__body">
                    <p class="slds-text-body_small">{labels.securityWarning}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </template>

      <!-- API Features & Tooling API Section (Always Visible) -->
      <div class="slds-box slds-theme_shade slds-m-bottom_medium">
        <h3 class="slds-text-heading_small slds-m-bottom_small">
          <lightning-icon
            icon-name="utility:settings"
            size="x-small"
            class="slds-m-right_xx-small"
          ></lightning-icon>
          {labels.apiFeaturesToolingApi}
        </h3>

        <!-- Global API Disclaimer -->
        <div
          class="slds-box slds-box_x-small slds-theme_warning slds-m-bottom_small"
          role="alert"
          aria-label={labels.toolingApiConsumptionWarning}
        >
          <div class="slds-media slds-media_center">
            <div class="slds-media__figure">
              <lightning-icon
                icon-name="utility:warning"
                size="medium"
                variant="warning"
                alternative-text={labels.warning}
              ></lightning-icon>
            </div>
            <div class="slds-media__body">
              <p class="slds-text-body_small">
                <strong>Tooling API Required:</strong> This application uses
                Salesforce Tooling API for:
              </p>
              <ul
                class="slds-list_dotted slds-m-top_xx-small slds-m-left_medium"
              >
                <li>
                  <strong>"Where is this used?"</strong> - Searches Flows (1-5
                  API calls per search)
                </li>
                <template if:true={canCreateMetadata}>
                  <li>
                    <strong>Create/Edit Configurations</strong> - Deploys
                    metadata (2-3 API calls per operation)
                  </li>
                </template>
              </ul>
              <p class="slds-text-body_small slds-m-top_xx-small">
                <strong>{labels.setupRequired}</strong>
                Tooling API must be accessible. Users need appropriate
                permissions to access Tooling API.
              </p>
              <p class="slds-text-body_small slds-m-top_xx-small">
                <a href="#" onclick={handleGoToDocumentation}
                  >{labels.toolingApiSetupLink}</a
                >
              </p>
            </div>
          </div>
        </div>

        <!-- Usage Tracking Toggle -->
        <div class="slds-m-top_small">
          <lightning-input
            type="checkbox"
            label='Enable "Where is this used?" search'
            checked={usageTrackingEnabled}
            onchange={handleUsageTrackingChange}
            disabled={isUpdatingSettings}
            field-level-help="When enabled, searches for configuration references in Apex and Flows. Consumes API calls for Flow searches."
          ></lightning-input>
        </div>
      </div>

      <!-- Two-Column Responsive Layout: Mobile (1 col) | Tablet+ (2 cols: 8/4) -->
      <lightning-layout multiple-rows="true" class="slds-gutters">
        <!-- RIGHT COLUMN: Controls Panel (Order: mobile=first, desktop=second) -->
        <lightning-layout-item
          size="12"
          medium-device-size="4"
          large-device-size="4"
          padding="around-small"
          class="slds-order_1 slds-medium-order_2"
        >
          <!-- Configuration Selection -->
          <div class="slds-m-bottom_medium">
            <!-- Phase 1 Refactor: Generic Searchable Combobox -->
            <c-jt-searchable-combobox
              test-id="config-selector"
              label={labels.selectConfiguration}
              placeholder={labels.searchConfigsPlaceholder}
              options={configurationOptions}
              no-results-text={labels.noResults}
              error-text={labels.selectOption}
              clear-button-title={labels.clear}
              show-options-title={labels.chooseConfiguration}
              debug-mode={dropdownDebugMode}
              name="configuration-selector"
              required
              onselect={handleConfigSelect}
              onclear={handleConfigClear}
            ></c-jt-searchable-combobox>

            <!-- Where is this used? Link (only when config selected AND enabled) -->
            <template if:true={showUsageLink}>
              <div class="slds-m-top_x-small slds-m-left_small">
                <a
                  href="#"
                  onclick={handleShowUsageModal}
                  class="usage-link slds-grid slds-grid_vertical-align-center slds-inline-flex"
                  title={labels.findWhereConfigurationUsed}
                >
                  <lightning-icon
                    icon-name="utility:search"
                    size="xx-small"
                    class="slds-m-right_xx-small slds-shrink-none"
                  ></lightning-icon>
                  Where is this used?
                </a>
              </div>
            </template>
          </div>

          <!-- Collapsible Sections: Run As User (Admin Only) -->
          <template if:true={showRunAs}>
            <lightning-accordion
              allow-multiple-sections-open
              class="slds-m-bottom_medium"
            >
              <lightning-accordion-section
                name="run-as"
                label={labels.runAsUserAdvanced}
              >
                <div class="slds-p-around_small">
                  <c-jt-run-as-section
                    user-options={userOptions}
                    is-loading-users={isLoadingUsers}
                    selected-user-id={runAsUserId}
                    selected-user-name={runAsUserName}
                    show-run-as-test={showRunAsTest}
                    is-running-test={isRunningTest}
                    onuserselect={handleUserSelect}
                    onuserclear={handleUserClear}
                    onclearselection={handleClearRunAs}
                    onexecuteasuser={handleExecuteAsUserTest}
                  ></c-jt-run-as-section>
                </div>
              </lightning-accordion-section>
            </lightning-accordion>
          </template>

          <!-- Dynamic Parameters Input -->
          <template if:true={hasParameters}>
            <div
              class="slds-m-bottom_medium parameters-scrollable slds-scrollable_y"
            >
              <c-jt-parameter-inputs
                parameters={parameters}
                title={labels.queryParameters}
                no-parameters-text={labels.noParametersRequired}
                onchange={handleParameterChange}
              ></c-jt-parameter-inputs>
            </div>
          </template>

          <!-- Configuration Bindings Info -->
          <template if:true={hasBindings}>
            <template if:false={hasParameters}>
              <div class="slds-m-bottom_medium">
                <div class="info-box-readable slds-box slds-text-body_small">
                  <strong class="info-title">
                    <lightning-icon
                      icon-name="utility:info"
                      size="x-small"
                      class="slds-m-right_x-small"
                    ></lightning-icon>
                    {labels.predefinedBindings}
                  </strong>
                  <div class="slds-m-top_x-small">
                    {labels.predefinedBindingsDesc}
                  </div>
                </div>
              </div>
            </template>
          </template>

          <!-- Execute Button -->
          <!-- Phase 3 Refactor: Extracted to jtExecuteButton -->
          <div class="slds-m-bottom_medium">
            <c-jt-execute-button
              label={labels.executeQuery}
              variant="brand"
              icon-name="utility:database"
              selected-config={selectedConfig}
              has-parameters={hasParameters}
              parameter-values={parameterValues}
              is-loading={isLoading}
              is-running-test={isRunningTest}
              onexecute={handleExecuteQuery}
            ></c-jt-execute-button>
          </div>
        </lightning-layout-item>
        <!-- End Right Column -->

        <!-- LEFT COLUMN: Results Area (Order: mobile=second, desktop=first) -->
        <lightning-layout-item
          size="12"
          medium-device-size="8"
          large-device-size="8"
          padding="around-small"
          class="slds-order_2 slds-medium-order_1"
        >
          <!-- Query Preview -->
          <template if:true={baseQuery}>
            <div
              class="query-preview-container slds-m-bottom_medium slds-p-left_small"
            >
              <div class="slds-text-heading_small slds-p-bottom_x-small">
                Query Preview:
              </div>
              <div
                class="query-preview slds-box slds-theme_shade slds-p-around_small slds-medium-p-around_medium slds-scrollable_x"
                style="max-height: 200px"
              >
                <pre
                  class="slds-text-body_small slds-medium-text-body_regular slds-m-around_none"
                >
{queryPreview}</pre
                >
              </div>

              <!-- Query Data Preview -->
              <template if:true={showPreviewData}>
                <div class="slds-m-top_small">
                  <div class="slds-text-heading_small slds-p-bottom_x-small">
                    {dataPreviewTitleFormatted}
                  </div>

                  <template if:true={isLoadingPreview}>
                    <div class="slds-text-align_center slds-p-vertical_medium">
                      <lightning-spinner
                        alternative-text={labels.loadingPreview}
                        size="small"
                      ></lightning-spinner>
                    </div>
                  </template>

                  <template if:false={isLoadingPreview}>
                    <lightning-datatable
                      key-field="Id"
                      data={previewPaginatedData}
                      columns={previewColumns}
                      hide-checkbox-column
                      show-row-number-column
                      class="slds-box"
                      data-testid="query-preview-table"
                    ></lightning-datatable>

                    <!-- Preview Pagination -->
                    <template if:true={showPreviewPagination}>
                      <div class="slds-m-top_x-small slds-text-align_center">
                        <lightning-button-group>
                          <lightning-button
                            label={labels.previousNew}
                            icon-name="utility:chevronleft"
                            onclick={handlePreviewPrevious}
                            disabled={previewHasPrevious}
                            data-testid="preview-prev-button"
                          ></lightning-button>
                          <lightning-button
                            label={previewPageInfo}
                            disabled
                            data-testid="preview-page-info"
                          ></lightning-button>
                          <lightning-button
                            label={labels.nextNew}
                            icon-name="utility:chevronright"
                            icon-position="right"
                            onclick={handlePreviewNext}
                            disabled={previewHasNext}
                            data-testid="preview-next-button"
                          ></lightning-button>
                        </lightning-button-group>
                      </div>
                    </template>
                  </template>
                </div>
              </template>
            </div>
          </template>

          <!-- Test Assert Message -->
          <template if:true={testAssertMessage}>
            <div class="slds-m-bottom_medium">
              <div class="slds-box slds-theme_success slds-text-body_regular">
                <lightning-icon
                  icon-name="utility:success"
                  size="small"
                  variant="success"
                  class="slds-m-right_small"
                ></lightning-icon>
                <strong>Test Assertion:</strong> {testAssertMessage}
              </div>
            </div>
          </template>

          <!-- Error Message -->
          <template if:true={showError}>
            <div class="slds-m-bottom_medium">
              <div
                class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_medium"
                role="alert"
              >
                <span class="slds-assistive-text">{labels.error}</span>
                <lightning-icon
                  icon-name="utility:error"
                  size="small"
                  variant="error"
                  class="slds-m-right_small"
                ></lightning-icon>
                <h2>{errorMessage}</h2>
              </div>
            </div>
          </template>

          <!-- Results Section -->
          <template if:true={showResults}>
            <div class="slds-m-top_medium slds-medium-m-top_large">
              <!-- üÜï Use jtQueryResults component with tree-grid support -->
              <c-jt-query-results
                columns={columns}
                records={queryResults}
                record-count={recordCount}
                page-size={pageSize}
              ></c-jt-query-results>

              <!-- JSON View -->
              <template if:true={viewMode.json}>
                <div
                  class="json-view slds-box slds-theme_shade slds-m-bottom_medium"
                >
                  <div
                    class="slds-grid slds-grid_align-spread slds-p-bottom_x-small"
                  >
                    <div class="slds-text-heading_small">
                      {labels.jsonOutput}
                    </div>
                    <lightning-button
                      label={labels.copy}
                      icon-name="utility:copy"
                      onclick={handleCopyJson}
                      variant="neutral"
                      class="slds-m-left_x-small"
                    ></lightning-button>
                  </div>
                  <pre
                    class="json-content slds-p-around_medium slds-text-body_small slds-medium-text-body_regular"
                  >
{jsonOutput}</pre
                  >
                </div>
              </template>

              <!-- CSV Download -->
              <template if:true={viewMode.csv}>
                <div
                  class="csv-view slds-box slds-theme_info slds-grid slds-grid_vertical slds-grid_align-center slds-grid_align-space-around slds-text-align_center slds-p-around_large"
                >
                  <lightning-icon
                    icon-name="utility:download"
                    size="large"
                    alternative-text={labels.downloadCsv}
                  ></lightning-icon>
                  <h3 class="slds-text-heading_medium slds-p-top_small">
                    {labels.downloadCsv}
                  </h3>
                  <p class="slds-text-body_regular slds-p-top_small">
                    {csvFileGeneratedMessage}
                  </p>
                  <lightning-button
                    label={labels.downloadCsvFile}
                    icon-name="utility:download"
                    onclick={handleDownloadCsv}
                    variant="brand"
                    class="slds-m-top_medium"
                  ></lightning-button>
                </div>
              </template>
            </div>
          </template>

          <!-- No Results Message -->
          <template if:true={hasResults}>
            <template if:false={showResults}>
              <div class="slds-p-top_medium">
                <div class="slds-align_absolute-center">
                  <lightning-icon
                    icon-name="utility:search"
                    size="large"
                  ></lightning-icon>
                  <div class="slds-text-heading_small slds-p-top_small">
                    No records found
                  </div>
                </div>
              </div>
            </template>
          </template>
        </lightning-layout-item>
        <!-- End Left Column -->
      </lightning-layout>
    </div>
  </lightning-card>

  <!-- Create/Edit Configuration Modal -->
  <template if:true={showCreateModal}>
    <c-jt-config-modal
      lwc:ref="configModal"
      mode={configModalMode}
      is-saving={isSaving}
      can-create-metadata={canCreateMetadata}
      is-loading-query-preview={isLoadingQueryPreview}
      query-preview-results={queryPreviewResults}
      query-preview-columns={queryPreviewColumns}
      onconfigchange={handleNewConfigChange}
      onsave={handleSaveConfiguration}
      oncancel={handleCloseCreateModal}
      onquerypreview={handleQueryPreview}
    ></c-jt-config-modal>
  </template>

  <!-- Cache Management Modal -->
  <template if:true={showCacheModal}>
    <c-jt-cache-modal
      lwc:ref="cacheModal"
      labels={labels}
      onclearcache={handleClearCache}
      onclose={handleCloseCacheModal}
    ></c-jt-cache-modal>
  </template>

  <!-- Query Risk Warning Modal -->
  <template if:true={showRiskWarningModal}>
    <section
      role="dialog"
      tabindex="-1"
      aria-labelledby="risk-modal-heading"
      class="slds-modal slds-fade-in-open"
    >
      <div class="slds-modal__container">
        <!-- Modal Header -->
        <header class="slds-modal__header slds-theme_warning">
          <h2 id="risk-modal-heading" class="slds-text-heading_medium">
            ‚ö†Ô∏è Query Risk Warning
          </h2>
        </header>

        <!-- Modal Body -->
        <div class="slds-modal__content slds-p-around_medium">
          <template if:true={queryRiskAssessment}>
            <!-- Risk Level Badge -->
            <div class="slds-m-bottom_medium">
              <p class="slds-text-body_small">
                <strong>Risk Level:</strong>
                <lightning-badge
                  label={queryRiskAssessment.riskLevel}
                ></lightning-badge>
              </p>
            </div>

            <!-- Risk Message -->
            <div
              class="slds-box slds-box_xx-small slds-theme_shade slds-m-bottom_medium"
            >
              <div class="slds-media">
                <div class="slds-media__figure">
                  <lightning-icon
                    icon-name="utility:info"
                    size="xx-small"
                    variant="info"
                  ></lightning-icon>
                </div>
                <div class="slds-media__body">
                  <p class="slds-text-body_regular">
                    {queryRiskAssessment.message}
                  </p>
                </div>
              </div>
            </div>

            <!-- Estimated Record Count -->
            <div class="slds-m-bottom_medium">
              <p class="slds-text-body_small slds-text-color_weak">
                <strong>Estimated Records:</strong>
                {queryRiskAssessment.estimatedRecordCount}
              </p>
            </div>

            <!-- Recommendation -->
            <template if:true={queryRiskAssessment.isCriticalRisk}>
              <div class="slds-box slds-theme_error slds-m-bottom_medium">
                <p class="slds-text-body_small">
                  <strong>‚õî Critical:</strong> This query will exceed
                  Salesforce's 50,000 record limit. Batch processing is
                  <strong>required</strong> to execute this query.
                </p>
              </div>
            </template>

            <template if:false={queryRiskAssessment.isCriticalRisk}>
              <div class="slds-box slds-theme_warning slds-m-bottom_medium">
                <p class="slds-text-body_small">
                  <strong>‚ö†Ô∏è Recommendation:</strong> We recommend using batch
                  processing for better performance and to avoid potential
                  timeouts or governor limits.
                </p>
              </div>
            </template>
          </template>
        </div>

        <!-- Modal Footer -->
        <footer class="slds-modal__footer">
          <lightning-button
            label={labels.cancelNew}
            onclick={handleCancelExecution}
            class="slds-m-right_small"
          ></lightning-button>

          <!-- Show "Proceed Normally" only if NOT critical -->
          <template if:false={queryRiskAssessment.isCriticalRisk}>
            <lightning-button
              label={labels.proceedNormally}
              variant="neutral"
              onclick={handleProceedNormal}
              class="slds-m-right_small"
            ></lightning-button>
          </template>

          <lightning-button
            label={labels.useBatchProcessing}
            variant="brand"
            icon-name="utility:database"
            onclick={handleProceedWithBatch}
          ></lightning-button>
        </footer>
      </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
  </template>

  <!-- Usage Finder Modal -->
  <template if:true={showUsageModal}>
    <c-jt-usage-modal
      config-name={selectedConfig}
      is-loading={isLoadingUsage}
      usage-data={usageResults}
      apex-error={usageServiceErrors.apex}
      flow-error={usageServiceErrors.flow}
      has-partial-results={hasPartialUsageResults}
      onclose={handleCloseUsageModal}
    ></c-jt-usage-modal>
  </template>
</template>
