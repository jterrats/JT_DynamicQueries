<template>
  <div class="results-container" role="region" aria-label={labels.queryResults}>
    <!-- Header with View Toggle -->
    <div class="slds-grid slds-grid_align-spread slds-p-bottom_small">
      <div class="slds-text-heading_small" id="results-heading">
        Results ({recordCount} {recordCountLabel}):
      </div>
      <lightning-button-group aria-label={labels.viewModeSelection}>
        <lightning-button
          label={labels.table}
          icon-name="utility:table"
          variant={isTableView}
          onclick={handleViewChange}
          data-view="table"
          title={labels.viewAsTable}
          aria-label={labels.viewResultsAsTable}
          aria-pressed={isTableActive}
        ></lightning-button>
        <lightning-button
          label={labels.json}
          icon-name="utility:file"
          variant={isJsonView}
          onclick={handleViewChange}
          data-view="json"
          title={labels.viewAsJson}
          aria-label={labels.viewResultsAsJson}
          aria-pressed={isJsonActive}
        ></lightning-button>
        <lightning-button
          label={labels.csv}
          icon-name="utility:download"
          variant={isCsvView}
          onclick={handleViewChange}
          data-view="csv"
          title={labels.downloadAsCsv}
          aria-label={labels.downloadResultsAsCsvFile}
          aria-pressed={isCsvActive}
        ></lightning-button>
      </lightning-button-group>
    </div>

    <!-- Table View -->
    <template if:true={viewMode.table}>
      <!-- Desktop: Nested Viewer with Child Relationships -->
      <div class="desktop-table slds-show_medium">
        <table class="slds-table slds-table_cell-buffer slds-table_bordered">
          <thead>
            <tr class="slds-line-height_reset">
              <th
                scope="col"
                style="width: 3rem"
                aria-label={labels.expandCollapse}
              ></th>
              <template for:each={parentColumns} for:item="col">
                <th key={col.fieldName} scope="col">
                  <div class="slds-truncate" title={col.label}>{col.label}</div>
                </th>
              </template>
            </tr>
          </thead>
          <tbody>
            <template for:each={paginatedResults} for:item="row">
              <!-- Parent Row -->
              <tr key={row.Id} class="slds-hint-parent">
                <td>
                  <template if:true={row._hasChildren}>
                    <lightning-button-icon
                      icon-name={row._expandIcon}
                      alternative-text={row._expandLabel}
                      variant="bare"
                      onclick={handleRowToggle}
                      data-id={row.Id}
                      class="slds-m-right_x-small"
                    ></lightning-button-icon>
                  </template>
                </td>
                <template for:each={row._cells} for:item="cell">
                  <td key={cell.key} data-label={cell.label}>
                    <div class="slds-truncate" title={cell.value}>
                      {cell.value}
                    </div>
                  </td>
                </template>
              </tr>
            </template>

            <!-- Expanded Children Sections (separate loop) -->
            <template for:each={paginatedResults} for:item="row">
              <template if:true={row._expanded}>
                <tr key={row._childrenKey}>
                  <td colspan="100" class="slds-p-around_medium">
                    <lightning-accordion
                      allow-multiple-sections-open
                      active-section-name={row._activeChildSections}
                    >
                      <template
                        for:each={row._childRelationships}
                        for:item="relationship"
                      >
                        <lightning-accordion-section
                          key={relationship.name}
                          name={relationship.name}
                          label={relationship.label}
                        >
                          <div class="slds-p-around_small">
                            <lightning-datatable
                              key-field="Id"
                              data={relationship.records}
                              columns={relationship.columns}
                              hide-checkbox-column
                            ></lightning-datatable>
                          </div>
                        </lightning-accordion-section>
                      </template>
                    </lightning-accordion>
                  </td>
                </tr>
              </template>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Mobile Cards -->
      <div
        class="mobile-cards slds-hide_medium"
        role="list"
        aria-label={labels.resultsAsExpandableCards}
      >
        <template for:each={paginatedResults} for:item="row">
          <article
            key={row.Id}
            class="slds-card slds-m-bottom_small"
            role="listitem"
            aria-label={row._ariaLabel}
          >
            <div
              class="slds-card__header slds-grid"
              onclick={handleCardToggle}
              data-id={row.Id}
              role="button"
              tabindex="0"
              aria-expanded={row._expanded}
              aria-label={row._toggleAriaLabel}
              onkeypress={handleCardKeyPress}
            >
              <header
                class="slds-media slds-media_center slds-has-flexi-truncate"
              >
                <div class="slds-media__figure">
                  <span class="slds-badge" aria-label={labels.rowNumber}
                    >{row._rowNumber}</span
                  >
                </div>
                <div class="slds-media__body">
                  <h2 class="slds-card__header-title">
                    <span class="slds-truncate">{row._displayName}</span>
                  </h2>
                </div>
                <div class="slds-no-flex">
                  <lightning-icon
                    icon-name={row._expandIcon}
                    size="x-small"
                    alternative-text={row._expandLabel}
                  ></lightning-icon>
                </div>
              </header>
            </div>
            <template if:true={row._expanded}>
              <div class="slds-card__body slds-card__body_inner">
                <dl class="slds-list_horizontal slds-wrap">
                  <template for:each={row._cells} for:item="cell">
                    <div
                      key={cell.key}
                      class="slds-item_detail slds-m-bottom_x-small"
                      style="width: 100%"
                    >
                      <dt
                        class="slds-item_label slds-text-color_weak slds-truncate"
                        title={cell.label}
                      >
                        {cell.label}:
                      </dt>
                      <dd
                        class="slds-item_detail slds-truncate"
                        title={cell.value}
                      >
                        {cell.value}
                      </dd>
                    </div>
                  </template>
                </dl>
              </div>
            </template>
          </article>
        </template>
      </div>
    </template>

    <!-- JSON View -->
    <template if:true={viewMode.json}>
      <div class="json-view slds-box slds-theme_shade slds-m-bottom_medium">
        <div class="slds-grid slds-grid_align-spread slds-p-bottom_x-small">
          <div class="slds-text-heading_small">{labels.jsonOutput}</div>
          <lightning-button
            label={labels.copy}
            icon-name="utility:copy"
            onclick={handleCopyJson}
            variant="neutral"
          ></lightning-button>
        </div>
        <pre class="json-content">{jsonOutput}</pre>
      </div>
    </template>

    <!-- CSV Preview -->
    <template if:true={viewMode.csv}>
      <div class="csv-view slds-box slds-theme_shade slds-m-bottom_medium">
        <div class="slds-grid slds-grid_align-spread slds-p-bottom_x-small">
          <div class="slds-text-heading_small">{labels.csvPreview}</div>
          <div>
            <lightning-button
              label={labels.copy}
              icon-name="utility:copy"
              onclick={handleCopyCsv}
              variant="neutral"
              class="slds-m-right_x-small"
            ></lightning-button>
            <lightning-button
              label={labels.download}
              icon-name="utility:download"
              onclick={handleDownloadCsv}
              variant="brand"
            ></lightning-button>
          </div>
        </div>
        <pre class="csv-content">{csvOutput}</pre>

        <template if:true={hasChildRecords}>
          <div
            class="slds-box slds-box_xx-small slds-theme_warning slds-m-top_small"
          >
            <div class="slds-media slds-media_small">
              <div class="slds-media__figure">
                <lightning-icon
                  icon-name="utility:info"
                  size="xx-small"
                  variant="warning"
                ></lightning-icon>
              </div>
              <div class="slds-media__body">
                <p class="slds-text-body_small">
                  <strong>{labels.note}</strong> {labels.csvNote}
                </p>
              </div>
            </div>
          </div>
        </template>
      </div>
    </template>

    <!-- Pagination Controls -->
    <template if:true={showPagination}>
      <nav
        aria-label={labels.paginationNavigation}
        class="slds-p-top_medium slds-grid slds-grid_align-spread slds-grid_vertical-align-center"
      >
        <div
          class="slds-text-body_small"
          role="status"
          aria-live="polite"
          aria-atomic="true"
        >
          <span class="slds-text-color_weak"
            >Page {currentPage} of {totalPages}</span
          >
          <span class="slds-m-horizontal_xx-small slds-text-color_weak">â€¢</span>
          <span class="slds-text-color_weak"
            >Showing {firstRecordIndex}-{lastRecordIndex} of {recordCount}
            {recordCountLabel}</span
          >
        </div>
        <div
          class="slds-button-group"
          role="group"
          aria-label={labels.paginationControls}
        >
          <lightning-button
            icon-name="utility:chevronleft"
            onclick={handlePreviousPage}
            disabled={disablePrevious}
            variant="neutral"
            title={labels.previousPage}
            aria-label={labels.goToPreviousPage}
          ></lightning-button>
          <lightning-button
            icon-name="utility:chevronright"
            onclick={handleNextPage}
            disabled={disableNext}
            variant="neutral"
            title={labels.nextPage}
            aria-label={labels.goToNextPage}
          ></lightning-button>
        </div>
      </nav>
    </template>
  </div>
</template>
