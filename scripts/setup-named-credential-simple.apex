// Script simplificado: Named Credential para callouts al mismo org
// Usa NoAuthentication porque el session ID se pasa manualmente en el cÃ³digo

String orgUrl = URL.getOrgDomainUrl().toExternalForm();
System.debug('Org URL: ' + orgUrl);
System.debug('');

try {
    // Crear External Credential con NoAuthentication
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    System.debug('ğŸ“‹ Step 1: Creating External Credential...');
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    ConnectApi.ExternalCredentialInput extCredInput = new ConnectApi.ExternalCredentialInput();
    extCredInput.developerName = 'JT_Tooling_API_External';
    extCredInput.masterLabel = 'JT Tooling API External';
    extCredInput.authenticationProtocol = ConnectApi.CredentialAuthenticationProtocol.NoAuthentication;

    ConnectApi.ExternalCredential extCred = ConnectApi.ExternalCredentials.createExternalCredential(extCredInput);

    System.debug('âœ… External Credential created!');
    System.debug('   Developer Name: ' + extCred.developerName);
    System.debug('   Master Label: ' + extCred.masterLabel);
    System.debug('   Protocol: NoAuthentication');
    System.debug('');

    // Crear Named Credential
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    System.debug('ğŸ“‹ Step 2: Creating Named Credential...');
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    ConnectApi.NamedCredentialInput namedCredInput = new ConnectApi.NamedCredentialInput();
    namedCredInput.developerName = 'JT_Tooling_API';
    namedCredInput.masterLabel = 'JT Tooling API';
    namedCredInput.type = ConnectApi.NamedCredentialType.SecuredEndpoint;
    namedCredInput.calloutUrl = orgUrl;
    namedCredInput.allowMergeFieldsInBody = false;
    namedCredInput.allowMergeFieldsInHeader = false;
    namedCredInput.generateAuthorizationHeader = false;
    namedCredInput.externalCredentialDeveloperName = 'JT_Tooling_API_External';

    ConnectApi.NamedCredential namedCred = ConnectApi.NamedCredentials.createNamedCredential(namedCredInput);

    System.debug('âœ… Named Credential created!');
    System.debug('   Developer Name: ' + namedCred.developerName);
    System.debug('   Master Label: ' + namedCred.masterLabel);
    System.debug('   Callout URL: ' + namedCred.calloutUrl);
    System.debug('   Type: ' + namedCred.type);
    System.debug('');

    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    System.debug('âœ… SETUP COMPLETE!');
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    System.debug('');
    System.debug('ğŸ’¡ Usage:');
    System.debug('   req.setEndpoint(\'callout:JT_Tooling_API/services/data/v65.0/tooling/...\');');
    System.debug('   req.setHeader(\'Authorization\', \'Bearer \' + UserInfo.getSessionId());');
    System.debug('');
    System.debug('Note: Session ID must be set manually in code (no auto-auth)');

} catch (ConnectApi.ConnectApiException e) {
    System.debug('âŒ ConnectApi Error: ' + e.getMessage());
    if (e.getMessage().contains('duplicate') || e.getMessage().contains('already exists')) {
        System.debug('');
        System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        System.debug('âš ï¸  Named Credential may already exist');
        System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        System.debug('To verify, go to Setup â†’ Named Credentials');
        System.debug('Look for: JT_Tooling_API');
    }
} catch (Exception e) {
    System.debug('âŒ Unexpected Error: ' + e.getMessage());
    System.debug('Stack Trace: ' + e.getStackTraceString());
}



