<template>
  <div class="slds-form-element" data-component="searchable-combobox">
    <!-- Label -->
    <template if:true={showLabel}>
      <label class={labelClass} for={inputId}>
        <template if:true={required}>
          <abbr class="slds-required" title="required">* </abbr>
        </template>
        <strong>{label}</strong>
      </label>
    </template>

    <!-- Combobox Control -->
    <div class="slds-form-element__control">
      <div class="slds-combobox_container">
        <div
          class={comboboxClass}
          aria-expanded={showDropdown}
          aria-haspopup="listbox"
          role="combobox"
          data-testid={comboboxTestId}
        >
          <!-- Input with Icon -->
          <div
            class="slds-combobox__form-element slds-input-has-icon slds-input-has-icon_right"
          >
            <input
              type="text"
              class={inputClass}
              id={inputId}
              name={inputName}
              data-testid={inputTestId}
              aria-controls={listboxId}
              aria-autocomplete="list"
              aria-label={ariaLabel}
              role="textbox"
              placeholder={placeholder}
              value={searchTerm}
              disabled={disabled}
              oninput={handleInput}
              onfocus={handleFocus}
              onblur={handleBlur}
              autocomplete="off"
            />

            <!-- Clear or Dropdown Icon -->
            <template if:true={showClearButton}>
              <button
                class="slds-button slds-button_icon slds-input__icon slds-input__icon_right"
                title={clearButtonTitle}
                onclick={handleClear}
                tabindex="-1"
              >
                <lightning-icon
                  icon-name="utility:clear"
                  alternative-text={clearButtonTitle}
                  size="x-small"
                ></lightning-icon>
              </button>
            </template>
            <template if:false={showClearButton}>
              <button
                class="slds-button slds-button_icon slds-input__icon slds-input__icon_right"
                title={showOptionsTitle}
                onclick={handleToggle}
                tabindex="-1"
              >
                <lightning-icon
                  icon-name="utility:down"
                  alternative-text={showOptionsTitle}
                  size="x-small"
                ></lightning-icon>
              </button>
            </template>
          </div>

          <!-- Dropdown List (Template Iteration - Simpler) -->
          <div
            id={listboxId}
            class={dropdownClass}
            role="listbox"
            data-testid={dropdownTestId}
          >
            <ul class="slds-listbox slds-listbox_vertical" role="presentation">
              <!-- Options -->
              <template if:true={hasOptions}>
                <template for:each={filteredOptions} for:item="option">
                  <li
                    key={option.value}
                    role="presentation"
                    class="slds-listbox__item"
                    data-testid={option.optionTestId}
                  >
                    <div
                      class="slds-media slds-listbox__option slds-listbox__option_plain slds-media_small"
                      role="option"
                      data-value={option.value}
                      data-label={option.label}
                      onclick={handleOptionSelect}
                      tabindex="0"
                    >
                      <span class="slds-media__body">
                        <span class="slds-truncate" title={option.label}>
                          {option.label}
                        </span>
                      </span>
                    </div>
                  </li>
                </template>
              </template>

              <!-- No results -->
              <template if:false={hasOptions}>
                <li role="presentation" class="slds-listbox__item">
                  <div class="slds-listbox__option slds-listbox__option_plain">
                    <span class="slds-truncate slds-text-color_weak">
                      {noResultsText}
                    </span>
                  </div>
                </li>
              </template>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Error message -->
    <template if:true={showErrorMessage}>
      <div class="slds-form-element__help slds-text-color_error" role="alert">
        {errorText}
      </div>
    </template>
  </div>
</template>
