<template>
  <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
    <div class="slds-modal__container">
      <!-- Modal Header -->
      <header class="slds-modal__header">
        <button
          class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse modal-close-button"
          title={labels.close}
          onclick={handleCancel}
        >
          <lightning-icon
            icon-name="utility:close"
            alternative-text={labels.close}
            size="small"
          ></lightning-icon>
          <span class="slds-assistive-text">{labels.close}</span>
        </button>
        <h2 class="slds-text-heading_medium slds-hyphenate">{title}</h2>

        <!-- Warning (only for create mode in non-dev environments) -->
        <template if:true={canCreateMetadata}>
          <div
            class="slds-m-top_small slds-box slds-theme_warning slds-p-around_small"
          >
            <p class="slds-grid slds-grid_vertical-align-center">
              <lightning-icon
                icon-name="utility:warning"
                size="xx-small"
                variant="warning"
                class="slds-m-right_xx-small"
              ></lightning-icon>
              <span class="slds-text-body_small" style="color: #080707">
                <strong>{labels.sandboxWarning}</strong>
              </span>
            </p>
          </div>
        </template>
      </header>

      <!-- Modal Body -->
      <div class="slds-modal__content slds-p-around_medium">
        <lightning-layout multiple-rows>
          <!-- Label -->
          <lightning-layout-item size="12" class="slds-p-bottom_small">
            <lightning-input
              type="text"
              label={labels.labelField}
              value={_config.label}
              data-field="label"
              onchange={handleFieldChange}
              required
              maxlength="40"
              placeholder={labels.labelPlaceholder}
            ></lightning-input>
          </lightning-layout-item>

          <!-- Developer Name -->
          <lightning-layout-item size="12" class="slds-p-bottom_small">
            <lightning-input
              type="text"
              label={labels.developerNameField}
              value={_config.developerName}
              data-field="developerName"
              onchange={handleFieldChange}
              required
              maxlength="40"
              placeholder={labels.developerNamePlaceholder}
              field-level-help={labels.developerNameHelpText}
            ></lightning-input>

            <!-- Warning when Developer Name changes in edit mode -->
            <template if:true={hasDeveloperNameChanged}>
              <div class="slds-m-top_x-small">
                <div
                  class="slds-notify slds-notify_alert slds-alert_warning"
                  role="alert"
                >
                  <span class="slds-assistive-text">{labels.warning}</span>
                  <span
                    class="slds-icon_container slds-icon-utility-warning slds-m-right_x-small"
                  >
                    <lightning-icon
                      icon-name="utility:warning"
                      size="xx-small"
                      variant="warning"
                      alternative-text={labels.warning}
                    ></lightning-icon>
                  </span>
                  <div class="slds-text-body_small">
                    {labels.developerNameChangeWarning}
                  </div>
                </div>
              </div>
            </template>
          </lightning-layout-item>

          <!-- Base Query -->
          <lightning-layout-item size="12" class="slds-p-bottom_small">
            <lightning-textarea
              label={labels.baseQueryField}
              value={_config.baseQuery}
              data-field="baseQuery"
              onchange={handleFieldChange}
              required
              rows="4"
              placeholder={labels.baseQueryPlaceholder}
            ></lightning-textarea>

            <!-- Query Validation -->
            <template if:true={_config.baseQuery}>
              <div class="slds-p-top_x-small">
                <template if:true={queryValidation.isValid}>
                  <div
                    class="slds-text-color_success slds-text-body_small slds-m-bottom_small"
                  >
                    <lightning-icon
                      icon-name="utility:success"
                      size="xx-small"
                      variant="success"
                    ></lightning-icon>
                    {queryValidation.message}
                    <template if:true={showObjectName}>
                      <span class="slds-m-left_small">
                        <strong>{labels.objectLabel}:</strong>
                        {queryValidation.objectName}
                      </span>
                    </template>
                  </div>

                  <!-- Query Preview -->
                  <template if:true={showQueryPreview}>
                    <div class="slds-m-top_small">
                      <div
                        class="slds-text-body_small slds-text-color_weak slds-m-bottom_xx-small"
                      >
                        <button
                          type="button"
                          class="slds-button slds-button_icon slds-button_icon-x-small slds-button_icon-bare slds-m-right_xx-small"
                          onclick={handleToggleQueryPreview}
                          title={labels.queryPreviewLabel}
                          aria-label={labels.queryPreviewLabel}
                        >
                          <lightning-icon
                            icon-name={queryPreviewIconName}
                            size="xx-small"
                            alternative-text={queryPreviewIconAlt}
                          ></lightning-icon>
                        </button>
                        {labels.queryPreviewLabel}
                      </div>
                      <template if:true={showQueryPreviewContent}>
                        <pre class="query-preview-text slds-box slds-box_x-small slds-theme_shade slds-p-around_small slds-m-around_none">{_config.baseQuery}</pre>
                      </template>
                    </div>
                  </template>
                </template>

                <template if:false={queryValidation.isValid}>
                  <template if:true={queryValidation.message}>
                    <div class="slds-text-color_error slds-text-body_small">
                      <lightning-icon
                        icon-name="utility:error"
                        size="xx-small"
                        variant="error"
                      ></lightning-icon>
                      {queryValidation.message}
                    </div>
                  </template>
                </template>

                <!-- Query Preview Data -->
                <template if:true={queryValidation.isValid}>
                  <div class="preview-datatable-container slds-m-top_small">
                    <template if:true={isLoadingQueryPreview}>
                      <div class="slds-text-align_center slds-p-around_medium">
                        <lightning-spinner
                          alternative-text={labels.loadingPreview}
                          size="small"
                        ></lightning-spinner>
                        <p
                          class="slds-text-body_small slds-text-color_weak slds-m-top_small"
                        >
                          {labels.loadingPreviewData}
                        </p>
                      </div>
                    </template>

                    <template if:true={hasPreviewData}>
                      <div class="slds-text-heading_small slds-m-top_small slds-m-bottom_x-small">
                        <button
                          type="button"
                          class="slds-button slds-button_icon slds-button_icon-x-small slds-button_icon-bare slds-m-right_xx-small"
                          onclick={handleToggleDataPreview}
                          title={labels.dataPreviewTitle}
                          aria-label={labels.toggleDataPreview}
                        >
                          <lightning-icon
                            icon-name={dataPreviewIconName}
                            size="xx-small"
                            alternative-text={dataPreviewIconAlt}
                          ></lightning-icon>
                        </button>
                        {labels.dataPreviewTitle}
                      </div>
                      <template if:true={showDataPreviewContent}>
                        <c-jt-query-results
                          columns={queryPreviewColumns}
                          records={queryPreviewResults}
                          record-count={queryPreviewResults.length}
                          page-size={queryPreviewPageSize}
                          class="preview-results"
                        ></c-jt-query-results>
                      </template>
                    </template>

                    <template if:false={hasPreviewData}>
                      <template if:false={isLoadingQueryPreview}>
                        <div
                          class="slds-text-body_small slds-text-color_weak slds-m-top_small"
                        >
                          <lightning-icon
                            icon-name="utility:info"
                            size="xx-small"
                            class="slds-m-right_xx-small"
                          ></lightning-icon>
                          {labels.noPreviewData}
                        </div>
                      </template>
                    </template>
                  </div>
                </template>
              </div>
            </template>
          </lightning-layout-item>

          <!-- Object Name (Auto-detected, read-only) -->
          <lightning-layout-item size="12" class="slds-p-bottom_small">
            <lightning-input
              type="text"
              label={labels.objectNameField}
              value={_config.objectName}
              readonly
              placeholder={labels.autoDetectedPlaceholder}
            ></lightning-input>
          </lightning-layout-item>

          <!-- Bindings -->
          <lightning-layout-item size="12" class="slds-p-bottom_small">
            <lightning-textarea
              label={labels.bindingsField}
              value={_config.bindings}
              data-field="bindings"
              onchange={handleFieldChange}
              rows="3"
              placeholder={labels.bindingsPlaceholder}
              field-level-help={labels.bindingsHelpText}
            ></lightning-textarea>
          </lightning-layout-item>

          <!-- Info Box -->
          <lightning-layout-item size="12" class="slds-p-top_small">
            <div class="slds-box slds-theme_info slds-text-body_small">
              <div class="slds-media slds-media_small">
                <div class="slds-media__figure">
                  <lightning-icon
                    icon-name="utility:info"
                    size="xx-small"
                    variant="info"
                  ></lightning-icon>
                </div>
                <div class="slds-media__body">
                  <strong>{labels.note}</strong> {dynamicToolingNote}
                </div>
              </div>
            </div>
          </lightning-layout-item>
        </lightning-layout>
      </div>

      <!-- Modal Footer -->
      <footer class="slds-modal__footer">
        <lightning-button
          label={labels.cancelLabel}
          onclick={handleCancel}
          class="slds-m-right_small"
        ></lightning-button>
        <lightning-button
          variant="brand"
          label={saveButtonLabel}
          onclick={handleSave}
          disabled={saveDisabled}
          icon-name="utility:save"
        ></lightning-button>
        <template if:true={isSaving}>
          <lightning-spinner
            alternative-text={labels.saving}
            size="small"
            class="slds-m-left_small"
          ></lightning-spinner>
        </template>
      </footer>
    </div>
  </section>
  <div class="slds-backdrop slds-backdrop_open"></div>
</template>